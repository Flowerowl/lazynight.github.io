---
title: SQL Injection Exploitation – DVWA
author: Flowerowl
layout: post
permalink: /2548.html
duoshuo_thread_id:
  - 1220743779864322400
views:
  - 1204
bot_views:
  - 2
categories:
  - 安全
  - 注入
tags:
  - DVWA
  - SQL Injection
---
(注意文章引号为英文半角格式)

SQL injection is considered a high risk vulnerability due to the fact that can lead to full compromise of the remote system.This is why in almost all web application penetration testing engagements,the applications are always checked for SQL injection flaws.A general and simple definition of when an application is vulnerable to SQL injection is when the application allows you to interact with the database and to execute queries on the database then it is vulnerable to SQL injection attacks.

There are many vulnerable applications that you can try in order to learn about SQL injection exploitation but in this article we will focus on the Damn Vulnerable Web Application (DVWA) and how we can extract information from the database by using SQL injection.Of course the methodology can be used and for any real life scenario in web application penetration tests.

In order to exploit SQL injection vulnerabilities we need to figure out how the query is built in order to inject our parameter in a situation that the query will remain true.For example in the DVWA we can see a text field where it asks for user ID.If we enter the number 1 and we click on the submit button we will notice that it will return the first name and the surname of the user with ID=1.

[<img class="alignnone size-full wp-image-2553" title="browse_010" src="http://lazynight.me/wp-content/uploads/2012/10/browse_010.png" alt="" width="494" height="207" />][1]

Extract First Name and Surname from ID Field

&nbsp;

This means that the query that was executed back in the database was the following:

<span style="color: #ff0000;"><strong>SELECT First_Name,Last_Name FROM users WHERE ID=’1′;</strong></span>

Now let’s have a look at the URL:

<span style="color: #ff0000;"><strong>http://172.16.212.133/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#</strong></span>

The injectable parameter on the URL is of course the id field so before we do anything else we can try to change the ID number on the URL to other values (i.e 2,3,4 etc.) in order to find the first names and surnames of all the users.For example we have discovered the following:

<span style="color: #ff0000;"><strong>id=2 —–> First Name: Gordon Surname: Brown</strong></span>

<span style="color: #ff0000;"><strong>id=3 —–> First Name: Hack Surname: Me</strong></span>

<span style="color: #ff0000;"><strong>id=4 —–> First Name: Pablo Surname: Picasso</strong></span>

<span style="color: #ff0000;"><strong>id=5 —–> First Name: Bob Surname: Smith</strong></span>

An alternative solution that would extract all the First names and Surnames from the table it would be to use the following injection string.The SQL query in this case will be something like this:

<span style="color: #ff0000;"><strong>SELECT First_Name,Last_Name FROM users WHERE ID=a’ OR ”=’;</strong></span>

The above statement it is always true so it will cause the application to return all the results.

[<img class="alignnone size-full wp-image-2557" title="browse_014" src="http://lazynight.me/wp-content/uploads/2012/10/browse_014.png" alt="" width="555" height="432" />][2]

Extracting all the First names and Surnames with one query

&nbsp;

The next step will be to try to identify what kind of database is running on the back-end in order to construct the queries accordingly and to extract the information that we want.This is very important because If we don’t know the database that exists behind we will not be able to exploit successfully the SQL injection vulnerability.Most of the times the web application technology (Java,ASP.NET,PHP etc.) will give us an idea of the database that the application is using.For example ASP.NET applications often using Microsoft SQL Server,PHP applications is likely to use MySQL and Java probably Oracle or MySQL.Additionally we can assume the database type from the web server and operating system of the target.For example if the web server is running Apache and PHP and it is a Linux host then the database has more possibilities to be MySQL.If it is an IIS then it is probably Microsoft SQL Server.Of course we cannot rely on these information,this is just for giving us an indication in order to speed the database fingerprint process.

We can very easily identify the database type especially if we are in a non-blind situation.The basic idea is to make the database to respond in a way that it will produce an error message that it will contain the database type and version. For example this can be achieved by a single quote because it will force the database to consider any characters that are following the quote as a string and not as SQL code and it will cause a syntax error.So now if we add a single quote on the vulnerable parameter id=’ this will make the database to generate an error message which as we can see from the image below it contains the database type which is MySQL server.

[<img class="alignnone size-full wp-image-2563" title="browse_013" src="http://lazynight.me/wp-content/uploads/2012/10/browse_0131.png" alt="" width="645" height="118" />][3]

Identifying the Database type via database error message

&nbsp;

Unfortunately in this example the web application didn’t return and the exact version of the database.However now that we know that the database is MySQL we can use the appropriate queries to find and the version.In MySQL the queries that will return the version of the database are the following:

<span style="color: #ff0000;"><strong>Select version()</strong> and <strong>Select @@version</strong></span>

So we will use the UNION statement in order to join two queries and to be able to discover the version of the database.Lets try to see what will happen if we give the following query:

<span style="color: #ff0000;"><strong>‘ union select @@version#</strong></span>

[<img class="alignnone size-full wp-image-2552" title="browse_009" src="http://lazynight.me/wp-content/uploads/2012/10/browse_009.png" alt="" width="565" height="196" />][4]

Different number of columns when the UNION statement was used

&nbsp;

This error indicates that the two select statements have not the same number of columns.That’s why we cannot have a proper result.In order to bypass this error there are two methods.Either we can increase the number of columns gradually of the second query until it returns the same number of columns with the first or we can use instead the null value as the null value can be converted to any data type.

So we have the query ‘ union select @@version# which provides us an error before.if we try to increase the number of columns by 1 the query will be: **‘ union select 1,@@version#**

The hash (#) sign is used in order to comment out the following SQL.We can see the result that we will have in the following image:

[<img class="alignnone size-full wp-image-2560" title="browse_018" src="http://lazynight.me/wp-content/uploads/2012/10/browse_018.png" alt="" width="459" height="291" />][5]

UNION statement – Same number of columns

&nbsp;

The query was executed successfully and we now have and the exact version of the MySQL.Alternatively we could have used the null value in order to fingerprint the database.The result would been exactly the same.

[<img title="browse_019" src="http://lazynight.me/wp-content/uploads/2012/10/browse_019.png" alt="" width="503" height="215" />][6]

UNION statement with null value usage

&nbsp;

The hostname of our target can be discovered with the @@hostname statement.Specifically we will have:

<span style="color: #ff0000;"><strong>‘ union select null,@@hostname #</strong></span>

which will produce the following result:

[<img class="alignnone size-full wp-image-2549" title="browse_005" src="http://lazynight.me/wp-content/uploads/2012/10/browse_005.png" alt="" width="412" height="201" />][7]

Hostname Discovery through SQL Injection

&nbsp;

Now that we have identify the database version and the hostname is time to find the number of columns.The order by command is used to sort information in a table.So we know from above that the structure of the query is the following:

<span style="color: #ff0000;"><strong>SELECT First_Name,Last_Name FROM users WHERE ID=’1′;</strong></span>

We can query the available columns of the table by using the order by syntax.So for example the query will be:

<span style="color: #ff0000;"><strong>SELECT First_Name,Last_Name FROM users WHERE ID=’ ‘ order by 1 #</strong></span>

[<img class="alignnone size-full wp-image-2564" title="browse_004" src="http://lazynight.me/wp-content/uploads/2012/10/browse_004.png" alt="" width="458" height="142" />][8]

Discovery of the number of columns

&nbsp;

As we can see and from the image above we didn’t get any error once the query has executed.This means that there is at least one column returned from the above query.Now if we try to increase the number of the columns by one making the query <span style="color: #ff0000;"><strong>‘ order by 2 #</strong> </span>we will not notice any changes and the page will be displayed properly.This also means that there are at least 2 columns.However if we try to increase by 3 (‘ order by 3 #) then we will notice the following error:

[<img class="alignnone size-full wp-image-2555" title="browse_012" src="http://lazynight.me/wp-content/uploads/2012/10/browse_012.png" alt="" width="439" height="132" />][9]

Wrong number of columns

&nbsp;

This means that the are only 2 columns returned when the above query is executed which in this case are the First\_Name and Last\_Name.

Next we will try to find the current database user.In MySQL the queries that can retrieve the current database user are two:

SELECT user();

SELECT current_user;

So if we try the following statement<span style="color: #ff0000;"> <strong>‘ union all select system_user(),user() #</strong> </span>it will combine the two select queries and it will allow also duplicate values in the results because we have used the union all operator.We can see the result of the following query in the next image:

[<img class="alignnone size-full wp-image-2550" title="browse_007" src="http://lazynight.me/wp-content/uploads/2012/10/browse_007.png" alt="" width="516" height="220" />][10]

Discovery of the current database user

&nbsp;

As we can see the current database user and the system user as well is the <span style="color: #ff0000;"><strong>root@localhost</strong></span>.Now we can use the <span style="color: #ff0000;"><strong>‘ union select null,database() #</strong> </span>to find the database name which in this case is the dvwa as we can see and from the image below:

[<img class="alignnone size-full wp-image-2554" title="browse_011" src="http://lazynight.me/wp-content/uploads/2012/10/browse_011.png" alt="" width="472" height="205" />][11]

Database Name Discovery

&nbsp;

The database version is **5.0.51a** this means that we can list all the available databases on the remote MySQL installation with the command select schema\_name from information\_schema.schemata which allows us to extract that kind of information regardless if we have administrator level privileges.So in our case and based on the previous query we will have:

<span style="color: #ff0000;"><strong>‘ union select null,schema_name from information_schema.schemata</strong></span>

and this will return to us the current databases which are the following:dvwa,metasploit,mysql,owasp10,tikiwiki and tikiwiki195.

[<img class="alignnone size-full wp-image-2551" title="browse_008" src="http://lazynight.me/wp-content/uploads/2012/10/browse_008.png" alt="" width="623" height="406" />][12]

Current MySQL databases

&nbsp;

Now that we have retrieved the databases we can try to discover the table names of the information_schema by using the following query:

<span style="color: #ff0000;"><strong>‘ union select null,table_name from information_schema.tables #</strong></span>

[<img class="alignnone size-full wp-image-2559" title="browse_017" src="http://lazynight.me/wp-content/uploads/2012/10/browse_017.png" alt="" width="594" height="515" />][13]

Sample of the tables of Information_Schema

&nbsp;

The information_schema is the database that contains information for all others databases that the MySQL maintains.Alternatively we can retrieve the tables from any database we want.In this example we will extract the tables from the database owasp10.So the query will be:

<span style="color: #ff0000;"><strong>‘ union select null,table_name from information_schema.tables where table_schema = ‘owasp10′ #</strong></span>

[<img class="alignnone size-full wp-image-2562" title="browse_020" src="http://lazynight.me/wp-content/uploads/2012/10/browse_020.png" alt="" width="645" height="279" />][14]

owasp10 – tables

&nbsp;

String concatenation can be also used in case that we want to join two or three strings to a single string.For example the following query will extract the column names of the table users:

<span style="color: #ff0000;"><strong>‘ union select null,concat(table_name,0x0a,column_name) from information_schema.columns where table_name= ‘users’ #</strong></span>

[<img class="alignnone size-full wp-image-2565" title="browse_002" src="http://lazynight.me/wp-content/uploads/2012/10/browse_002.png" alt="" width="443" height="434" />][15]

Discover Column Names of Table users

&nbsp;

So we now have the columns from the table users.We can see that there is a column with the name password so we might want to display the contents of this along with the first name or last name of the user.So we need to execute the following query:

<span style="color: #ff0000;"><strong>‘ union select null,concat(first_name,0x0a,password) from users #</strong></span>

[<img class="alignnone size-full wp-image-2566" title="browse_003" src="http://lazynight.me/wp-content/uploads/2012/10/browse_003.png" alt="" width="600" height="370" />][16]

Display the first name and the password hash of the table users

&nbsp;

Now we have all the hashes for all the users which can be cracked offline.Another simple query that we can execute and it will return us the location of the database on the remote system system is the **<span style="color: #ff0000;">‘ union select null,@@datadir #</span> **

[<img class="alignnone size-full wp-image-2558" title="browse_015" src="http://lazynight.me/wp-content/uploads/2012/10/browse_015.png" alt="" width="434" height="207" />][17]

Location of Database Files

&nbsp;

We can also try to read a file from the remote system.The path that we are always looking for is of course the /etc/passwd where older Linux systems were storing the passwords.We will execute the following query:

<span style="color: #ff0000;"><strong>‘ union all select load_file(‘/etc/passwd’),null #</strong></span>

and we will get the following result:

[<img class="alignnone size-full wp-image-2567" title="browse" src="http://lazynight.me/wp-content/uploads/2012/10/browse.png" alt="" width="496" height="260" />][18]

Read the contents of passwd file

&nbsp;

**Conclusion**

As we saw from this article SQL injection is a high critical vulnerability because once it has been discovered it allows us with the use of the appropriate queries to extract information both from the database and the system.Damn vulnerable web application give us the opportunity to exploit this vulnerability in order to understand better how sql injection works and of course to stay ethical.

此文转载自：http://pentestlab.wordpress.com/2012/09/18/sql-injection-exploitation-dvwa/

&nbsp;

转载请注明：[于哲的博客][19] &raquo; [SQL Injection Exploitation – DVWA][20]

 [1]: http://lazynight.me/wp-content/uploads/2012/10/browse_010.png
 [2]: http://lazynight.me/wp-content/uploads/2012/10/browse_014.png
 [3]: http://lazynight.me/wp-content/uploads/2012/10/browse_0131.png
 [4]: http://lazynight.me/wp-content/uploads/2012/10/browse_009.png
 [5]: http://lazynight.me/wp-content/uploads/2012/10/browse_018.png
 [6]: http://lazynight.me/wp-content/uploads/2012/10/browse_019.png
 [7]: http://lazynight.me/wp-content/uploads/2012/10/browse_005.png
 [8]: http://lazynight.me/wp-content/uploads/2012/10/browse_004.png
 [9]: http://lazynight.me/wp-content/uploads/2012/10/browse_012.png
 [10]: http://lazynight.me/wp-content/uploads/2012/10/browse_007.png
 [11]: http://lazynight.me/wp-content/uploads/2012/10/browse_011.png
 [12]: http://lazynight.me/wp-content/uploads/2012/10/browse_008.png
 [13]: http://lazynight.me/wp-content/uploads/2012/10/browse_017.png
 [14]: http://lazynight.me/wp-content/uploads/2012/10/browse_020.png
 [15]: http://lazynight.me/wp-content/uploads/2012/10/browse_002.png
 [16]: http://lazynight.me/wp-content/uploads/2012/10/browse_003.png
 [17]: http://lazynight.me/wp-content/uploads/2012/10/browse_015.png
 [18]: http://lazynight.me/wp-content/uploads/2012/10/browse.png
 [19]: http://localhost/wordpress
 [20]: http://localhost/wordpress/2548.html